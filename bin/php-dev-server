#!/usr/bin/env php
<?php

use C3\PhpDevServer\ConfigManager;
use C3\PhpDevServer\WebserverInstaller;

set_time_limit(0);

$autoloaderPath = determineComposerAutoloadPath();
require $autoloaderPath;

$composerJsonPath = dirname(dirname($autoloaderPath)) . '/composer.json';
$composerJson = file_get_contents($composerJsonPath);

if (!WebserverInstaller::isInstalled()) {
    WebserverInstaller::install();
}

$configManager = new ConfigManager($composerJson);

$workingDirectory = dirname($composerJsonPath);
$symfonyBinary = '"${HOME}/.symfony/bin/symfony"';
$symfonyParams = [
    'server:start',
    '--port=' . $configManager->getPort(),
    '--dir=' . $configManager->getWebDirectory(),
];

if (!$configManager->isTlsEnabled()) {
    $symfonyParams[] = '--no-tls';
}

if (null !== $configManager->getP12File()) {
    // Handle custom p12 file
    if (0 === strpos($configManager->getP12File(), '/')) {
        $file = new SplFileInfo($configManager->getP12File());
    } else {
        $file = new SplFileInfo($workingDirectory) . '/' . $configManager->getP12File();
    }

    if (!$file->isReadable()) {
        die('Could not read P12 file: ' . $file->getPath());
    }

    // Replace original symfony/cli default.p12
    passthru('rsync -av ' . escapeshellarg($file->getRealPath()) . ' "${HOME}/.symfony/certs/default.p12"');
}

passthru('cd ' . escapeshellarg($workingDirectory) . ' && ' . $symfonyBinary . ' ' . implode(' ', $symfonyParams));

/**
 * @return SplFileInfo
 * @throws RuntimeException
 */
function determineComposerAutoloadPath()
{
    $dir = __DIR__;
    while (!empty($dir) && $dir !== '/') {
        if (is_readable($dir . '/autoload.php')) {
            return new SplFileInfo($dir . '/autoload.php');
        }
        if (is_readable($dir . '/vendor/autoload.php')) {
            return new SplFileInfo($dir . '/vendor/autoload.php');
        }
        $dir = dirname($dir);
    }

    throw new RuntimeException('autoload.php not found');
}
